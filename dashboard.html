<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - BoxIM ENLTbot</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <a href="/">BoxIM ENLTbot</a>
            </div>
            <div class="navbar-menu">
                <a href="/dashboard" class="active">ä»ªè¡¨æ¿</a>
                {% if user.role == 'admin' %}
                <a href="/users">ç”¨æˆ·ç®¡ç†</a>
                <a href="/logs">ç³»ç»Ÿæ—¥å¿—</a>
                {% endif %}
                <a href="/settings">è®¾ç½®</a>
                <a href="/logout">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>ğŸ“Š æœºå™¨äººçŠ¶æ€</h1>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>è¿è¡ŒçŠ¶æ€</h3>
                <div class="status-indicator {{ 'status-online' if bot_status.is_connected else 'status-offline' }}">
                    {{ 'ğŸŸ¢ åœ¨çº¿' if bot_status.is_connected else 'ğŸ”´ ç¦»çº¿' }}
                </div>
                <p>ç™»å½•çŠ¶æ€: {{ 'ğŸŸ¢ å·²ç™»å½•' if bot_status.is_logged_in else 'ğŸ”´ æœªç™»å½•' }}</p>
                <p>ç”¨æˆ·ID: {{ bot_status.user_id or 'æœªçŸ¥' }}</p>
            </div>

            <div class="status-card">
                <h3>è¿è¡Œä¿¡æ¯</h3>
                <p>è¿è¡Œæ—¶é—´: {{ bot_status.uptime }}</p>
                <p>å¯åŠ¨æ—¶é—´: {{ bot_status.start_time }}</p>
                <p>æœ€åæ¶ˆæ¯: {{ bot_status.last_message_time }}</p>
                <p>ä»Šæ—¥æ¶ˆæ¯: {{ bot_status.message_count_today }}</p>
            </div>

            <div class="status-card">
                <h3>è¿æ¥çŠ¶æ€</h3>
                <p>é‡è¿æ¬¡æ•°: {{ bot_status.ws_reconnect_count }}</p>
                <p>Tokenè¿‡æœŸ: {{ bot_status.access_token_expires }}</p>
                <p>åˆ·æ–°Tokenè¿‡æœŸ: {{ bot_status.refresh_token_expires }}</p>
            </div>

            <div class="status-card">
                <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
                <p>æ€»ç”¨æˆ·æ•°: {{ stats.total_users }}</p>
                <p>æ´»è·ƒç”¨æˆ·: {{ stats.active_users }}</p>
                <p>æ€»æ¶ˆæ¯æ•°: {{ stats.total_messages }}</p>
                <p>æ€»ç¾¤èŠæ•°: {{ stats.total_groups }}</p>
            </div>
        </div>

        <div class="actions">
            {% if user.role == 'admin' %}
            <button onclick="restartBot()" class="btn btn-warning">é‡å¯æœºå™¨äºº</button>
            <button onclick="stopBot()" class="btn btn-danger">åœæ­¢æœºå™¨äºº</button>
            {% endif %}
            <button onclick="refreshStatus()" class="btn btn-primary">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="info">
            <h3>ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</h3>
            <p>Webç•Œé¢ç‰ˆæœ¬: v2.4.0</p>
            <p>æœºå™¨äººè´¦å·: {{ bot_status.username }}</p>
            <p>å½“å‰æ—¶é—´: <span id="current-time"></span></p>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>BoxIM ENLTbot &copy; 2025 Entropy Light. All rights reserved.</p>
            <p>å½“å‰ç”¨æˆ·: {{ user.username }} ({{ user.role }}) | æœ€åæ›´æ–°: <span id="last-update"></span></p>
        </div>
    </footer>

    <script src="/static/js/script.js"></script>
    <script>
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
            document.getElementById('last-update').textContent = now.toLocaleString('zh-CN');
        }
        
        function refreshStatus() {
            location.reload();
        }
        
        async function restartBot() {
            if (!confirm('ç¡®å®šè¦é‡å¯æœºå™¨äººå—ï¼Ÿ')) return;
            
            const response = await fetch('/api/restart_bot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            alert(result.message || result.error);
            if (result.success) refreshStatus();
        }
        
        async function stopBot() {
            if (!confirm('ç¡®å®šè¦åœæ­¢æœºå™¨äººå—ï¼Ÿ')) return;
            
            const response = await fetch('/api/stop_bot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            alert(result.message || result.error);
            if (result.success) refreshStatus();
        }
        
        // åˆå§‹åŒ–
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>