<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - BoxIM ENLTbot</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <a href="/">BoxIM ENLTbot</a>
            </div>
            <div class="navbar-menu">
                <a href="/dashboard">ä»ªè¡¨æ¿</a>
                <a href="/users" class="active">ç”¨æˆ·ç®¡ç†</a>
                <a href="/logs">ç³»ç»Ÿæ—¥å¿—</a>
                <a href="/settings">è®¾ç½®</a>
                <a href="/logout">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h1>
        
        <div class="card">
            <h3>æ·»åŠ æ–°ç”¨æˆ·</h3>
            <form id="add-user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">ç”¨æˆ·å</label>
                        <input type="text" id="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input type="password" id="password" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label for="role">è§’è‰²</label>
                        <select id="role">
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">æ·»åŠ ç”¨æˆ·</button>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="card">
            <h3>ç”¨æˆ·åˆ—è¡¨</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>è§’è‰²</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æœ€åç™»å½•</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in web_users %}
                        <tr>
                            <td>{{ u.id }}</td>
                            <td>{{ u.username }}</td>
                            <td>
                                <span class="badge {% if u.role == 'admin' %}badge-admin{% else %}badge-user{% endif %}">
                                    {% if u.role == 'admin' %}ç®¡ç†å‘˜{% else %}æ™®é€šç”¨æˆ·{% endif %}
                                </span>
                            </td>
                            <td>{{ u.created_at }}</td>
                            <td>{% if u.last_login %}{{ u.last_login }}{% else %}ä»æœªç™»å½•{% endif %}</td>
                            <td>
                                <span class="badge {% if u.is_active == 1 %}badge-active{% else %}badge-inactive{% endif %}">
                                    {% if u.is_active == 1 %}æ¿€æ´»{% else %}ç¦ç”¨{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if u.id != user.id %}
                                        {% if u.is_active == 1 %}
                                        <button data-action="toggle" data-user-id="{{ u.id }}" data-new-status="0"
                                                class="btn btn-small btn-warning">
                                            ç¦ç”¨
                                        </button>
                                        {% else %}
                                        <button data-action="toggle" data-user-id="{{ u.id }}" data-new-status="1"
                                                class="btn btn-small btn-success">
                                            æ¿€æ´»
                                        </button>
                                        {% endif %}
                                        
                                        {% if u.role == 'user' %}
                                        <button data-action="change-role" data-user-id="{{ u.id }}" data-new-role="admin"
                                                class="btn btn-small btn-info">
                                            è®¾ä¸ºç®¡ç†å‘˜
                                        </button>
                                        {% else %}
                                        <button data-action="change-role" data-user-id="{{ u.id }}" data-new-role="user"
                                                class="btn btn-small btn-secondary">
                                            è®¾ä¸ºç”¨æˆ·
                                        </button>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">å½“å‰ç”¨æˆ·</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="info">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>ç®¡ç†å‘˜</strong>å¯ä»¥ç®¡ç†æ‰€æœ‰ç”¨æˆ·ï¼ŒåŒ…æ‹¬æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹æƒé™</li>
                <li><strong>æ™®é€šç”¨æˆ·</strong>åªèƒ½æŸ¥çœ‹ä»ªè¡¨æ¿å’Œä¿®æ”¹è‡ªå·±çš„å¯†ç </li>
                <li>ä¸èƒ½ä¿®æ”¹å½“å‰ç™»å½•ç”¨æˆ·çš„çŠ¶æ€</li>
                <li>è¯·è°¨æ…åˆ†é…ç®¡ç†å‘˜æƒé™</li>
            </ul>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>BoxIM ENLTbot &copy; 2025 Entropy Light. All rights reserved.</p>
            <p>å½“å‰ç”¨æˆ·: {{ user.username }} ({{ user.role }})</p>
        </div>
    </footer>

    <script src="/static/js/script.js"></script>
    <script>
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            
            if (password.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            const response = await fetch('/api/add_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password, role})
            });
            
            const result = await response.json();
            alert(result.message || result.error);
            if (result.success) location.reload();
        });
        
        async function toggleUser(userId, newStatus) {
            const action = newStatus == 1 ? 'æ¿€æ´»' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ`)) return;
            
            const response = await fetch('/api/update_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, is_active: newStatus})
            });
            
            const result = await response.json();
            alert(result.message || result.error);
            if (result.success) location.reload();
        }
        
        async function changeRole(userId, newRole) {
            const roleName = newRole === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
            if (!confirm(`ç¡®å®šè¦å°†ç”¨æˆ·è§’è‰²æ”¹ä¸º${roleName}å—ï¼Ÿ`)) return;
            
            const response = await fetch('/api/update_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, role: newRole})
            });
            
            const result = await response.json();
            alert(result.message || result.error);
            if (result.success) location.reload();
        }
    </script>
</body>
</html>